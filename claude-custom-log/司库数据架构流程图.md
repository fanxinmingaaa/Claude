# 司库管理系统数据架构流程图

> 以下流程图使用 Mermaid 语法，可在飞书、语雀、Typora、VS Code 等支持 Mermaid 的工具中渲染查看

---

## 一、整体架构流程图

```mermaid
flowchart TB
    subgraph SOURCE["司库管理系统 (218张表)"]
        direction LR
        subgraph BIZ["司库业务系统"]
            BILL[票据系统<br/>36张表]
            LOAN[贷款系统<br/>44张表]
            CREDIT[授信系统<br/>17张表]
            GUARANTEE[担保系统<br/>20张表]
            BG[保函系统<br/>6张表]
            ACCOUNT[账户系统<br/>12张表]
            OTHER_BIZ[其他业务<br/>16张表]
        end
        subgraph FIN["财务核算系统"]
            AR[应收应付<br/>32张表]
            INVOICE[发票管理<br/>9张表]
            RECON[银行对账<br/>8张表]
            CONFIG[组织配置<br/>18张表]
        end
    end

    subgraph COLLECT["数据采集层"]
        CDC[CDC实时采集<br/>Debezium]
        DATAX[DataX批量采集]
    end

    subgraph PLATFORM["数据处理平台"]
        subgraph MIDDLE["司库业务中台<br/>151张表 · 实时处理"]
            M_SERVICE[业务服务层<br/>票据/贷款/授信/担保中心]
            M_AGG[业务聚合层<br/>业务全景视图]
            M_DETAIL[业务明细层<br/>事件流/交易流水]
            M_ODS[业务贴源层<br/>fbm/cdmc/ccc/gpmc]
        end
        subgraph LAKE["数据湖<br/>67张表 · 批处理"]
            L_ADS[应用层 ADS<br/>财务报表/分析指标]
            L_DWS[汇总层 DWS<br/>应收汇总/应付汇总]
            L_DWD[明细层 DWD<br/>明细宽表]
            L_ODS[贴源层 ODS<br/>ar/ap/arap/sscivm/gl]
        end
    end

    subgraph SERVICE["数据服务层"]
        API[统一数据服务<br/>API网关]
    end

    subgraph APP["应用层"]
        DASHBOARD[管理驾驶舱]
        REPORT[财务报表]
        ALERT[风险预警]
        ANALYSIS[业务分析]
    end

    %% 数据流向
    BIZ --> CDC
    FIN --> DATAX

    CDC --> M_ODS
    DATAX --> L_ODS

    M_ODS --> M_DETAIL --> M_AGG --> M_SERVICE
    L_ODS --> L_DWD --> L_DWS --> L_ADS

    M_SERVICE <--> API
    L_ADS <--> API

    API --> DASHBOARD
    API --> REPORT
    API --> ALERT
    API --> ANALYSIS

    %% 样式
    style SOURCE fill:#e1f5fe
    style MIDDLE fill:#fff3e0
    style LAKE fill:#e8f5e9
    style SERVICE fill:#f3e5f5
    style APP fill:#fce4ec
```

---

## 二、数据流转流程图

```mermaid
flowchart LR
    subgraph INPUT["数据源"]
        A1[司库业务系统<br/>218张表]
    end

    subgraph CLASSIFY["数据分类"]
        B1[司库特有数据<br/>151张表<br/>69.3%]
        B2[公共数据<br/>67张表<br/>30.7%]
    end

    subgraph SYNC["数据同步"]
        C1[CDC实时同步<br/>秒级延迟]
        C2[DataX批量同步<br/>T+1]
    end

    subgraph PROCESS["数据处理"]
        D1[业务中台<br/>Flink实时计算]
        D2[数据湖<br/>Spark批处理]
    end

    subgraph COMPUTE["核心计算"]
        E1[额度实时计算<br/>风险实时预警<br/>业务状态流转]
        E2[账龄分析<br/>坏账计提<br/>对账处理]
    end

    subgraph OUTPUT["数据服务"]
        F1[业务服务API]
        F2[数据服务API]
    end

    subgraph FINAL["统一服务"]
        G1[管理驾驶舱<br/>财务报表<br/>风险监控]
    end

    A1 --> B1
    A1 --> B2
    B1 --> C1
    B2 --> C2
    C1 --> D1
    C2 --> D2
    D1 --> E1
    D2 --> E2
    E1 --> F1
    E2 --> F2
    F1 --> G1
    F2 --> G1

    F1 <-.-> F2

    style B1 fill:#fff3e0
    style B2 fill:#e8f5e9
    style D1 fill:#fff3e0
    style D2 fill:#e8f5e9
```

---

## 三、数据湖分层流程图

```mermaid
flowchart TB
    subgraph SOURCE["数据源 (67张公共表)"]
        S1[ar_* 应收类]
        S2[ap_* 应付类]
        S3[arap_* 核销计提]
        S4[sscivm_* 发票]
        S5[gl_* 对账]
        S6[org_* 组织]
    end

    subgraph ODS["贴源层 ODS"]
        O1[数据同步<br/>DataX增量/全量]
        O2[数据清洗<br/>去重/空值处理]
        O3[数据校验<br/>主键/外键检查]
    end

    subgraph DWD["明细层 DWD"]
        D1[应收明细宽表<br/>dwd_ar_receivable_detail]
        D2[应付明细宽表<br/>dwd_ap_payable_detail]
        D3[发票明细宽表<br/>dwd_invoice_detail]
        D4[对账明细宽表<br/>dwd_reconciliation_detail]
    end

    subgraph DWS["汇总层 DWS"]
        W1[应收账款汇总<br/>dws_ar_receivable_summary]
        W2[应付账款汇总<br/>dws_ap_payable_summary]
        W3[银行余额汇总<br/>dws_bank_balance_summary]
        W4[发票统计汇总<br/>dws_invoice_summary]
    end

    subgraph ADS["应用层 ADS"]
        A1[财务分析指标<br/>ads_finance_analysis]
        A2[财务报表数据<br/>ads_finance_report]
        A3[数据服务API<br/>公共数据服务]
    end

    SOURCE --> ODS
    ODS --> DWD
    DWD --> DWS
    DWS --> ADS

    style ODS fill:#e3f2fd
    style DWD fill:#e8f5e9
    style DWS fill:#fff8e1
    style ADS fill:#fce4ec
```

---

## 四、业务中台分层流程图

```mermaid
flowchart TB
    subgraph SOURCE["数据源 (151张业务表)"]
        S1[fbm_* 票据]
        S2[cdmc_* 贷款]
        S3[ccc_* 授信]
        S4[gpmc_* 担保]
        S5[bgm_* 保函]
        S6[tam_* 账户]
    end

    subgraph BODS["业务贴源层"]
        O1[CDC实时同步<br/>Debezium]
        O2[事件流<br/>Kafka]
        O3[版本管理<br/>_v表处理]
    end

    subgraph BDM["业务明细层"]
        D1[票据事件表<br/>bdm_bill_event]
        D2[贷款流水表<br/>bdm_loan_transaction]
        D3[授信变动表<br/>bdm_credit_change]
        D4[担保变动表<br/>bdm_guarantee_change]
    end

    subgraph BDS["业务聚合层"]
        W1[票据全景<br/>bds_bill_panorama]
        W2[贷款全景<br/>bds_loan_panorama]
        W3[授信全景<br/>bds_credit_panorama]
        W4[担保全景<br/>bds_guarantee_panorama]
    end

    subgraph BSV["业务服务层"]
        A1[票据中心API]
        A2[贷款中心API]
        A3[授信中心API]
        A4[担保中心API]
        A5[预警服务API]
    end

    SOURCE --> BODS
    BODS --> BDM
    BDM --> BDS
    BDS --> BSV

    style BODS fill:#e3f2fd
    style BDM fill:#fff3e0
    style BDS fill:#fff8e1
    style BSV fill:#f3e5f5
```

---

## 五、技术架构流程图

```mermaid
flowchart TB
    subgraph MIDDLE["司库业务中台"]
        direction TB
        M1[Flink<br/>实时计算引擎]
        M2[Kafka<br/>消息队列]
        M3[Redis<br/>状态缓存]
        M4[MySQL/TiDB<br/>业务存储]
        M5[Drools<br/>规则引擎]
        M6[XXL-Job<br/>任务调度]

        M2 --> M1
        M1 --> M3
        M1 --> M4
        M5 --> M1
        M6 --> M1
    end

    subgraph LAKE["数据湖"]
        direction TB
        L1[Spark<br/>批处理引擎]
        L2[Hive/Iceberg<br/>数据存储]
        L3[DataX<br/>数据同步]
        L4[DolphinScheduler<br/>任务调度]
        L5[Great Expectations<br/>数据质量]

        L3 --> L2
        L2 --> L1
        L4 --> L1
        L5 --> L1
    end

    subgraph EXCHANGE["数据交互"]
        E1[数据服务总线]
        E2[Seata<br/>分布式事务]
        E3[数据对账<br/>T+1校验]
    end

    MIDDLE <--> E1
    LAKE <--> E1
    E2 --> E1
    E3 --> E1

    style MIDDLE fill:#fff3e0
    style LAKE fill:#e8f5e9
    style EXCHANGE fill:#f3e5f5
```

---

## 六、数据分类分布图

```mermaid
pie title 218张数据表分布
    "票据管理 (36)" : 36
    "贷款管理 (44)" : 44
    "授信管理 (17)" : 17
    "担保管理 (20)" : 20
    "保函管理 (6)" : 6
    "账户管理 (12)" : 12
    "其他业务 (16)" : 16
    "应收应付 (23)" : 23
    "坏账计提 (9)" : 9
    "发票管理 (9)" : 9
    "银行对账 (8)" : 8
    "组织配置 (18)" : 18
```

---

## 七、处理流程时序图

```mermaid
sequenceDiagram
    participant BIZ as 司库业务系统
    participant CDC as CDC采集
    participant KAFKA as Kafka
    participant FLINK as Flink
    participant REDIS as Redis
    participant MYSQL as MySQL
    participant API as 业务API

    BIZ->>CDC: 业务数据变更
    CDC->>KAFKA: 发送事件消息
    KAFKA->>FLINK: 消费事件
    FLINK->>FLINK: 业务规则计算
    FLINK->>REDIS: 更新额度缓存
    FLINK->>MYSQL: 持久化业务数据
    API->>REDIS: 查询实时额度
    REDIS-->>API: 返回额度数据
    API->>MYSQL: 查询业务详情
    MYSQL-->>API: 返回业务数据
```

---

## 八、数据湖处理时序图

```mermaid
sequenceDiagram
    participant SRC as 源系统
    participant DATAX as DataX
    participant ODS as ODS层
    participant DWD as DWD层
    participant DWS as DWS层
    participant ADS as ADS层
    participant API as 数据API

    Note over SRC,API: 每日凌晨批处理
    SRC->>DATAX: 增量数据抽取
    DATAX->>ODS: 数据同步
    ODS->>ODS: 数据清洗校验
    ODS->>DWD: 维度关联加工
    DWD->>DWS: 汇总计算
    DWS->>ADS: 指标计算
    API->>ADS: 查询分析数据
    ADS-->>API: 返回指标数据
```

---

## 九、双平台协同流程图

```mermaid
flowchart LR
    subgraph LAKE["数据湖"]
        L1[利率数据]
        L2[账龄数据]
        L3[坏账数据]
        L4[组织数据]
    end

    subgraph MIDDLE["业务中台"]
        M1[利息计算]
        M2[信用评估]
        M3[授信占用]
        M4[贷款余额]
    end

    subgraph EXCHANGE["数据交互"]
        E1((数据服务<br/>总线))
    end

    L1 -->|利率基准| E1
    L2 -->|账龄分析| E1
    L3 -->|坏账率| E1
    L4 -->|组织架构| E1

    E1 -->|基础数据| M1
    E1 -->|风险数据| M2

    M3 -->|业务回流| E1
    M4 -->|业务回流| E1

    E1 -->|回流数据| L1

    style LAKE fill:#e8f5e9
    style MIDDLE fill:#fff3e0
    style E1 fill:#f3e5f5
```

---

## 十、实施路线流程图

```mermaid
flowchart LR
    subgraph P1["第一阶段"]
        A1[数据分类]
        A2[清单确认]
    end

    subgraph P2["第二阶段"]
        B1[数据湖ODS]
        B2[数据湖DWD]
        B3[数据湖DWS]
        B4[数据湖ADS]
    end

    subgraph P3["第三阶段"]
        C1[中台贴源层]
        C2[中台明细层]
        C3[中台聚合层]
        C4[中台服务层]
    end

    subgraph P4["第四阶段"]
        D1[服务对接]
        D2[一致性验证]
        D3[上线运行]
    end

    P1 --> P2
    P2 --> P3
    P3 --> P4

    style P1 fill:#e3f2fd
    style P2 fill:#e8f5e9
    style P3 fill:#fff3e0
    style P4 fill:#f3e5f5
```

---

## 使用说明

### 在线渲染
- 飞书文档：直接粘贴 Mermaid 代码块
- 语雀：直接粘贴 Mermaid 代码块
- GitHub：直接粘贴 Mermaid 代码块

### 本地渲染
- VS Code：安装 Markdown Preview Mermaid Support 插件
- Typora：原生支持 Mermaid
- Obsidian：原生支持 Mermaid

### 导出图片
- 使用 [Mermaid Live Editor](https://mermaid.live/) 在线编辑并导出 PNG/SVG
